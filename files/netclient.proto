#!/bin/sh
# Copyright 2024-2026 MOSSDeF, Stan Grishin (stangri@melmac.ca)
# Licensed to the public under the Apache License 2.0.

# shellcheck disable=SC1091,SC3003,SC3043
# ubus -v list network.interface.netmaker
# ubus call network.interface.netmaker status

# https://github.com/openwrt/openwrt/blob/494c5691c60316aa710fbf5a6d38bdb04ff14f76/package/network/services/unetd/files/unetd.sh
# https://github.com/openwrt/openwrt/blob/494c5691c60316aa710fbf5a6d38bdb04ff14f76/package/network/utils/wireguard-tools/files/wireguard.sh#L26

# shellcheck disable=SC2034
readonly PKG_VERSION='dev-test'
readonly PROG='/usr/bin/netclient'
readonly IP='/sbin/ip'
readonly WG='/usr/bin/wg'

[ -x "$PROG" ] || exit 0
[ -x "$IP" ] || exit 0
[ -x "$WG" ] || exit 0

. /lib/functions.sh
. /lib/functions/network.sh
. ../netifd-proto.sh

init_proto "$@"

log() {
	logger -t 'netclient' "$*"
}

netclient_init_config() {
#	proto_config_add_string key
	proto_config_add_string 'l3_device'
}

proto_netclient_setup() {
	local cfg="$1" interface address addresses
	local device key

	config_load network
	json_get_vars device key
	device="${device:-$cfg}"
	device="${device:-netmaker}"
	interface="$device"

	log "Setting up ${interface} from netclient daemon."
	proto_run_command "$cfg" "$PROG" daemon

	sleep 2
	proto_init_update "${interface}" 1

	addresses="$(ip -4 a list dev "$interface" 2>/dev/null | grep inet | awk '{print $2}' | awk -F "/" '{print $1}')"
	log "Running ${interface} from netclient daemon${addresses+: with addresses: $addresses}."
	for address in ${addresses}; do
		case "${address}" in
			*:*/*)
				proto_add_ipv6_address "${address%%/*}" "${address##*/}"
				;;
			*.*/*)
				proto_add_ipv4_address "${address%%/*}" "${address##*/}"
				local subnet=$(ipcalc.sh "${address%%/*}/24" | grep NETWORK | cut -d= -f2)
				proto_add_ipv4_route "${subnet}" "24" "${address%%/*}"
				;;
			*:*)
				proto_add_ipv6_address "${address%%/*}" "128"
				;;
			*.*)
				proto_add_ipv4_address "${address%%/*}" "32"
				local subnet=$(ipcalc.sh "${address%%/*}/24" | grep NETWORK | cut -d= -f2)
				proto_add_ipv4_route "${subnet}" "24" "${address%%/*}"
				;;
		esac
	done
	proto_send_update "${cfg}"
}

proto_netclient_teardown() {
	local config="$1"
	local interface="$2"
	local device key

	json_get_vars device key
	device="${device:-$interface}"
	device="${device:-$config}"
	device="${device:-netmaker}"

	logger -t 'netclient' "Tearing down $interface :: $config :: $device"
	proto_kill_command "$interface"

	"$IP" link del dev "$device"

#	json_init
#	json_add_string name "$device"
#	json_add_string key "$key"
#	ubus call netclient network_del "$(json_dump)"
}

add_protocol netclient
